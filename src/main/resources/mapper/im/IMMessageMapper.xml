<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hsx.manyue.modules.im.mapper.IMMessageMapper">

    <!-- 查询历史消息 -->
    <select id="queryHistory" resultType="com.hsx.manyue.modules.im.model.entity.IMMessageEntity">
        SELECT * FROM t_im_message
        WHERE is_delete = 0
        AND (
            (session_type = 1 AND ((from_user_id = #{userId} AND to_user_id = #{targetId}) 
                                OR (from_user_id = #{targetId} AND to_user_id = #{userId})))
            OR
            (session_type = 2 AND to_group_id = #{targetId})
        )
        <if test="startSeq != null">
            AND msg_seq &lt; #{startSeq}
        </if>
        ORDER BY msg_seq DESC
        LIMIT #{limit}
    </select>

    <!-- 统计未读消息数 -->
    <select id="countUnread" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_im_message
        WHERE to_user_id = #{userId}
        AND status = 0
        AND is_delete = 0
    </select>

    <!-- 同步消息 -->
    <select id="syncMessages" resultType="com.hsx.manyue.modules.im.model.entity.IMMessageEntity">
        SELECT * FROM t_im_message
        WHERE is_delete = 0
        AND msg_seq > #{lastSeq}
        AND (
            to_user_id = #{userId}
            OR from_user_id = #{userId}
            OR to_group_id IN (
                SELECT group_id FROM t_im_group_member 
                WHERE user_id = #{userId} AND is_delete = 0
            )
        )
        ORDER BY msg_seq ASC
    </select>

</mapper>
